"""
Script to generate JSON files from RCV result reports.

Usage:

  $ python src/rcvresults/scripts/parse_results.py --help

"""

import argparse
from argparse import RawDescriptionHelpFormatter
import logging
from pathlib import Path

import rcvresults.election as election_mod


_log = logging.getLogger('parse-results')

DEFAULT_OUTPUT_DIR = 'output-json'

DESCRIPTION = """\
Generate JSON files from RCV result reports.

This script parses XML or Excel result reports generated by the Dominion
system and saves the resulting data as JSON files, one per contest.
"""


def make_arg_parser():
    parser = argparse.ArgumentParser(
        description=DESCRIPTION, formatter_class=RawDescriptionHelpFormatter,
    )
    parser.add_argument(
        'report_paths', metavar='PATH', type=Path, nargs='*', help=(
            'path to one or more XML or Excel result reports.'
        ),
    )
    parser.add_argument(
        '--output-dir', metavar='OUTPUT_DIR', help=(
            'path to the html output directory. '
            f'Defaults to: {DEFAULT_OUTPUT_DIR}.'
        ), default=DEFAULT_OUTPUT_DIR,
    )
    return parser


def main():
    parser = make_arg_parser()
    args = parser.parse_args()

    log_format = '[{levelname}] {name}: {message}'
    logging.basicConfig(format=log_format, style='{', level=logging.INFO)

    report_paths = args.report_paths
    output_dir = Path(args.output_dir)

    count = len(report_paths)
    _log.info(f'processing {count} input paths...')
    if not output_dir.exists():
        _log.info(f'creating directory: {output_dir}')
        output_dir.mkdir(parents=True)

    for i, input_path in enumerate(report_paths, start=1):
        input_path = Path(input_path)
        _log.info(f'parsing file {i} (of {count}): {input_path}')
        election_mod.make_rcv_json(input_path, output_dir=output_dir)

    _log.info(f'wrote {count} files to directory: {output_dir}')


if __name__ == '__main__':
    main()

